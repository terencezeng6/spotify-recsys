<!DOCTYPE html>
<html>
  <head>
    <title>Top Tracks</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body class="body-flexible">
    <div class="back-container">
      <form action="/" method="get">
        <button class="secondary-btn" type="submit">&lt;&lt;</button>
      </form>
    </div>

    <!-- dropdown to select time range -->
    <div style="padding-top: 50px;">
      <label for="time_range">Time range: &nbsp;</label>
      <select id="time_range" name="time_range">
        <option value="" {% if not selected_range %}selected{% endif %}>Select Duration</option>
        <option value="short_term" {% if selected_range == 'short_term' %}selected{% endif %}>4 weeks</option>
        <option value="medium_term" {% if selected_range == 'medium_term' %}selected{% endif %}>6 months</option>
        <option value="long_term" {% if selected_range == 'long_term' %}selected{% endif %}>12 months</option>
      </select>
    </div>

    <!-- dropdown to select mood -->
    <div>
      <label for="mood">Mood: &nbsp;</label>
      <select id="mood" name="mood">
        <option value="" {% if not selected_mood %}selected{% endif %}>Select Mood</option>
        <option value="angry" {% if selected_mood == 'angry' %}selected{% endif %}>Angry</option>
        <option value="stimulated" {% if selected_mood == 'stimulated' %}selected{% endif %}>Stimulated</option>
        <option value="excited" {% if selected_mood == 'excited' %}selected{% endif %}>Excited</option>
        <option value="distressed" {% if selected_mood == 'distressed' %}selected{% endif %}>Distressed</option>
        <option value="neutral" {% if selected_mood == 'neutral' %}selected{% endif %}>Neutral</option>
        <option value="happy" {% if selected_mood == 'happy' %}selected{% endif %}>Happy</option>
        <option value="sad" {% if selected_mood == 'sad' %}selected{% endif %}>Sad</option>
        <option value="tired" {% if selected_mood == 'tired' %}selected{% endif %}>Tired</option>
        <option value="relaxed" {% if selected_mood == 'relaxed' %}selected{% endif %}>Relaxed</option>
      </select>
    </div>

    <!-- display recommendations (if they exist) -->

    {% if vanilla_rec or biased_rec %}
    <section id="recommendations">
      <h2>Recommendations</h2>

      {% if vanilla_rec %}
        <div class="rec">
          <iframe data-testid="embed-iframe" style="border-radius:12px" 
          src="https://open.spotify.com/embed/track/{{vanilla_rec}}?utm_source=generator" 
          width="100%" height="300" frameBorder="0" allowfullscreen="" 
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
          loading="lazy">
          </iframe>
        </div>
      {% endif %}

      {% if vanilla_rec %}
        <div class="rec">
          <iframe data-testid="embed-iframe" style="border-radius:12px" 
          src="https://open.spotify.com/embed/track/{{biased_rec}}?utm_source=generator" 
          width="100%" height="300" frameBorder="0" allowfullscreen="" 
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
          loading="lazy">
          </iframe>
        </div>
      {% endif %}

    {% endif %}

    </section>

    <!-- display tracks -->
    {% if tracks %}

      <div id="scatterplot-container">
        <h3>Energy vs. Valence of Your Top Tracks</h3>
        <div id="scatterplot"></div>
      </div>

      <h2>Most played tracks in the past 
        {% if selected_range == 'short_term' %}
          4 weeks
        {% elif selected_range == 'medium_term' %}
          6 months
        {% elif selected_range == 'long_term' %}
          12 months
        {% else %}
          ?
        {% endif %}
      </h2>
      <ol>
        {% for track in tracks %}
          <li>
            <strong>{{track.name}} â€” {{track.artist}}</strong><br>
            {% if track.available %}
              Acousticness: {{ track.acousticness }}<br>
              Danceability: {{ track.danceability }}<br>
              Energy: {{ track.energy }}<br>
              Instrumentalness: {{ track.instrumentalness }}<br>
              Loudness: {{ track.loudness }} dB<br>
              Valence: {{ track.valence }}<br>
            {% else %}
              <em>Audio features not available for this track.</em>
            {% endif %}
          </li>
          <br>
        {% endfor %}
      </ol>
    {% else %}
        <p>Please select a time range to view your top tracks.</p>
    {% endif %}

    <!-- refresh page when dropdown item is selected -->

    <script>
      function updateQueryParam(key, value) {
        const params = new URLSearchParams(window.location.search);

        if (value && value !== "") {
          params.set(key, value);
        } else {
          params.delete(key);
        }

        const newQuery = params.toString();
        const newUrl = window.location.pathname + (newQuery ? "?" + newQuery : "");
        window.location.href = newUrl;
      }

      document.getElementById('time_range').addEventListener('change', function() {
        updateQueryParam('time_range', this.value);
      });

      document.getElementById('mood').addEventListener('change', function() {
        updateQueryParam('mood', this.value);
      });
    </script>

    <!-- jsonify tracks data -->
    <script id="track-data" type="application/json">
      {{ tracks|tojson }}
    </script>

    <!-- create scatterplot -->
    <script src="{{ url_for('static', filename='scatterplot.js') }}"></script>
    {% if tracks %}
      <script>  
        const rawData = document.getElementById("track-data").textContent;
        const tracks = JSON.parse(rawData);
        const filtered_tracks = tracks.filter(d => d.available);
        renderScatterplot(filtered_tracks);
      </script>
    {% endif %}
  </body>
</html>